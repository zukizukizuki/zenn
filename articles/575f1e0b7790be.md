---
title: "ã€CI/CDã€‘tfcmtã‚’å°å…¥ã—ã¦terraformã®CI/CDã‚’æ”¹å–„ã™ã‚‹"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform" , "tfcmt" , "aws" , "codebuild" , "ci"]
published: true
---

## tfcmtã¨ã¯
Plan/Applyçµæœã‚’PRç­‰ã«é€šçŸ¥ã—ã¦ãã‚Œã‚‹
ãŠã‹ã’ã§ã„ã¡ã„ã¡CI/CDãƒ„ãƒ¼ãƒ«ã‚’è¦‹ã«è¡Œã‹ãªãã¦æ¸ˆ

## ã‚„ã‚‹äº‹
ä»¥å‰CodeBuildã§CI/CDã‚’çµ„ã‚“ã [aws-terraform](https://zukkie.link/terraform-v1-5-0%e3%81%a7%e8%bf%bd%e5%8a%a0%e3%81%95%e3%82%8c%e3%81%9fimport%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%81%bf%e3%82%8b/)ã«
tfcmtã‚’çµ„ã‚“ã§PRã«é€šçŸ¥ã•ã‚Œã‚‹æ§˜ã«ã—ã¾ã™ã€‚

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
Githubã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«èªè¨¼ãŒå¿…è¦ãªã®ã§GITHUB_TOKENãŒå¿…è¦ã«ãªã‚‹ã€‚
ä»Šå›ã¯Githubã§ä½œæˆã—AWSã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ä¿å­˜ã™ã‚‹ã€‚

1. AWS ã«ãƒ­ã‚°ã‚¤ãƒ³ â†’ ã‚·ã‚¹ãƒ†ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â†’ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ â†’ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½œæˆ
![](https://storage.googleapis.com/zenn-user-upload/f1231c6fe913-20230809.png)
2. "åå‰"ã‚’å…¥åŠ›
"å®‰å…¨ãªæ–‡å­—åˆ—"ã«ãƒã‚§ãƒƒã‚¯
"å€¤"ã‚’å…¥åŠ›
![](https://storage.googleapis.com/zenn-user-upload/b39d7e7fd234-20230809.png)
3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆ

å‚è€ƒè³‡æ–™ï¼š
https://suzuki-shunsuke.github.io/tfcmt/getting-started/
https://docs.github.com/ja/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens


## ã‚³ãƒ¼ãƒ‰ã®ç·¨é›†

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã®å€¤ã‚’Codebuildã‹ã‚‰å–å¾—ã—ã€scriptsã§ä½¿ã†

### codebuild/buildspec-dryrun.yml

```diff
version: 0.2

env:
  parameter-store:
    GITHUB_TOKEN: "codebuild-github-token"

phases:
  install:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/install.sh
      - ${CODEBUILD_SRC_DIR}/scripts/install.sh

  build:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/dryrun.sh
      - ${CODEBUILD_SRC_DIR}/scripts/dryrun.sh
```

### codebuild/buildspec-apply.yml

```diff
version: 0.2

env:
  parameter-store:
    GITHUB_TOKEN: "codebuild-github-token"

phases:
  install:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/install.sh
      - ${CODEBUILD_SRC_DIR}/scripts/install.sh

  build:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/apply.sh
      - ${CODEBUILD_SRC_DIR}/scripts/apply.sh
```

### scripts/install.sh

```
#!/bin/sh

set -ex

TERRAFORM_VERSION="1.5.4"
TFCMT_VERSION="v4.4.3"

wget -q "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
unzip -d /usr/local/bin "terraform_${TERRAFORM_VERSION}_linux_amd64.zip"

wget "https://github.com/suzuki-shunsuke/tfcmt/releases/download/${TFCMT_VERSION}/tfcmt_linux_amd64.tar.gz" -P /tmp
tar zxvf /tmp/tfcmt_linux_amd64.tar.gz -C /tmp
mv /tmp/tfcmt /usr/local/bin/tfcmt
```

### scripts/dryrun.sh

```
#!/bin/sh
set -ex
terraform init -var USERID=${userID} -input=false -no-color -backend-config="key=terraform.tfstate" -backend-config="bucket=zukkie-terraform-state"
terraform validate -no-color
tfcmt plan -- terraform plan -no-color -var USERID=${userID}
```

### scripts/apply.sh

```
#!/bin/sh
set -ex
terraform init -var USERID=${userID} -input=false -no-color -backend-config="key=terraform.tfstate" -backend-config="bucket=zukkie-terraform-state"
terraform validate -no-color
tfcmt apply -- terraform apply -auto-approve -no-color -var USERID=${userID}
```

## Plan/Applyé€šã—ã¦å•é¡Œãªã‘ã‚Œã°çµæœãŒPRã«é€šçŸ¥ã•ã‚Œã‚‹
![](https://storage.googleapis.com/zenn-user-upload/49940fc12c10-20230809.png)

## æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰

https://github.com/zukizukizuki/aws-terraform/tree/12fd6e0d108de1ad46aedb006138ad9dfd8ee84c

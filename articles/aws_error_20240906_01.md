---
title: "ã€MYSQLã€‘Failed to connect to database: (1045, \"Access denied for user ãŒå‡ºã‚‹"
emoji: "ğŸ…"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, rds, error, error]
published: true
---

## ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
```
Failed to connect to database: (1045, "Access denied for user 'dev_admin'@'172.31.1.129' (using password: YES)")
```

## åŸå› 
ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„å ´åˆã«ç™ºç”Ÿã—ã¾ã™ã€‚

## å¯¾å‡¦æ–¹æ³•
1. AWS Secrets Managerã®ç¢ºèª
   - Secrets Managerã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ç¢ºèª
   - å¿…è¦ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Terraformã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£:
   ```
   resource "aws_secretsmanager_secret_version" "db_credential" {
     secret_id = aws_secretsmanager_secret.db_credential.id
     secret_string = jsonencode({
       username = "${var.environment}_${var.DB_USERNAME}"
       password = var.DB_PASSWORD
     })
   }
   ```

2. RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
   - RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç›´æ¥æ¥ç¶šã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - å¿…è¦ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®SQLã‚³ãƒãƒ³ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã¾ãŸã¯æ¨©é™ã‚’ä»˜ä¸:
   ```
   CREATE USER 'dev_admin'@'%' IDENTIFIED BY 'password';
   GRANT ALL PRIVILEGES ON *.* TO 'dev_admin'@'%';
   FLUSH PRIVILEGES;
   ```

3. Lambdaé–¢æ•°ã®ç’°å¢ƒå¤‰æ•°ç¢ºèª
   - Lambdaé–¢æ•°ã®ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - Terraformã‚³ãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª:
   ```
   resource "aws_lambda_function" "db_dump" {
     # ä»–ã®è¨­å®š...
     environment {
       variables = {
         RDS_USER     = "${var.environment}_${var.DB_USERNAME}"
         RDS_PASSWORD = var.DB_PASSWORD
         # ä»–ã®ç’°å¢ƒå¤‰æ•°...
       }
     }
   }
   ```

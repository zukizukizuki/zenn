---
title: "ã€AWSã€‘CodeBuildã§terraformã«CICDã‚’çµ„ã‚€"
emoji: "ğŸ‘½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform" , "aws" , "codebuild" , "ci" , "cd"]
published: true
---

## åˆã‚ã«

terraform v1.5.0ã§ importãƒ–ãƒ­ãƒƒã‚¯ãªã‚‹ã‚‚ã®ãŒè¿½åŠ ã•ã‚ŒãŸã€‚ã“ã‚ŒãŒã‚‚ã®ã™ã”ãã„ã„æ©Ÿèƒ½ã§
å¾“æ¥ã ã¨

- terraform importã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ãŸ
- importã‚’ã™ã‚‹ã«ã¯ãƒªã‚½ãƒ¼ã‚¹ã‚’1ã¤ãšã¤ãƒãƒãƒãƒimportã—ã¦ã„ãŸ
- tfãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã™ã‚‹éš›ã«tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã‹ã‚ŒãŸå†…å®¹ã‚’è¦‹ãªãŒã‚‰è¨˜è¿°ã—ã¦ã„ãŸ
- importçµæœãŒäºˆæ¸¬ã—ãšã‚‰ã„

ã“ã‚ŒãŒimportãƒ–ãƒ­ãƒƒã‚¯ãŒå‡ºæ¥ãŸäº‹ã§

- ã‚³ãƒ¼ãƒ‰å†…ã§å®Œçµã™ã‚‹ã‚ˆã†ã«ãªã£ãŸ
- è¤‡æ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’importå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã£ãŸ
- tfãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•ã§ä½œã‚‰ã‚Œã‚‹
- importçµæœã‚’äºˆæ¸¬ã§ãã‚‹

æ§˜ã«ãªã£ãŸã®ã§importçµ¡ã¿ã®ä½œæ¥­ãŒã™ã”ãæ¥½ã«ãªã‚‹

## ä»Šå›ã‚„ã‚‹äº‹

ä»¥å‰[CI/CDã‚’çµ„ã‚€éš›](https://zukkie.link/%e3%80%90aws%e3%80%91codebuild%e3%81%a7terraform%e3%81%abcicd%e3%82%92%e7%b5%84%e3%82%80/)ã«ä½œã£ãŸCodeBuildã¨ãƒ­ãƒ¼ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã‚’importãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã£ã¦terraformç®¡ç†ä¸‹ã«ã™ã‚‹ã€‚

## importãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”¨ã„ã¦terraformç®¡ç†ä¸‹ã«ã™ã‚‹

id ã¨ toã ã‘æ›¸ã‘ã°OK

å‚è€ƒï¼šhttps://developer.hashicorp.com/terraform/language/import
https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/codebuild_project#import
https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role#import
https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy#import

### imports.tf ã®ä½œæˆ

```
#CodeBuild
import {
  to = aws_codebuild_project.terraform_apply
  id = "terraform-apply"
}

import {
  to = aws_codebuild_project.terraform_dryrun
  id = "terraform-dryrun"
}

#ãƒ­ãƒ¼ãƒ«
import {
  to = aws_iam_role.terraform_plan
  id = "codebuild-s-service-role"
}

import {
  to = aws_iam_role.terraform_plan
  id = "codebuild-t-service-role"
}

#ãƒãƒªã‚·ãƒ¼
import {
  to = aws_iam_policy.terraform_apply
  id = "arn:aws:iam::${userID}:policy/service-role/CodeBuildBasePolicy-terraform-apply-ap-northeast-1"
}

import {
  to = aws_iam_policy.terraform_dryrun
  id = "arn:aws:iam::${userID}:policy/service-role/CodeBuildBasePolicy-terraform-dryrun-ap-northeast-1"
}
```

### [concurrent_build_limit](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/codebuild_project#concurrent_build_limit)ã‚’ä¿®æ­£ã™ã‚‹

CodeBuildã®åŒæ™‚ãƒ“ãƒ«ãƒ‰åˆ¶é™ã‚’è¨­å®šã—ã¦ã„ãªã¨concurrent_build_limitã®å€¤ãŒ0ã«ãªã‚ŠPlanãŒã“ã‘ã‚‹ã€‚
importãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã£ãŸæ™‚ã®ãƒã‚°ã£ã½ã„ã®ã§ä¸€æ—¦ "1" ã«è¨­å®šã™ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/4d614bceecbb-20230808.png)

### tfãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹

ã¾ãšã¯GUIã‚’å‚ç…§ã—ã€codebuild.tfã‚’ä½œæˆã™ã‚‹ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ

```
terraform init
terraform plan -generate-config-out="codebuild.tf"
```

### å…¬é–‹ã—ãŸããªã„æƒ…å ±ã‚’CodeBuildã®ç’°å¢ƒå¤‰æ•°ã«æŒ‡å®šã—ã¦ãã‚Œã‚’shellã«æ¸¡ã™

#### ç’°å¢ƒå¤‰æ•°ã‚’CodeBuildã«è¨­å®š

- CodeBuild â†’ å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ â†’ ç·¨é›† â†’ ç’°å¢ƒ ã® "ç’°å¢ƒå¤‰æ•°" ã‹ã‚‰è¨­å®š 

#### ç’°å¢ƒå¤‰æ•°ã‚’æ¸¡ã™ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£

scripts/dryrun.sh ã®ä¿®æ­£

```
#!/bin/sh
set -ex
terraform init -var USERID=${userID} -input=false -no-color -backend-config="key=terraform.tfstate" -backend-config="bucket=zukkie-terraform-state"
terraform plan -no-color -var USERID=${userID}
```

scripts/apply.sh ã®ä¿®æ­£

```
#!/bin/sh
set -ex
terraform init -var USERID=${userID} -input=false -no-color -backend-config="key=terraform.tfstate" -backend-config="bucket=zukkie-terraform-state"
terraform apply -auto-approve -no-color -var USERID=${userID}
```

variable.tf ã®ä½œæˆ

```
variable "USERID" {}
```

#### codebuild.tfã®ä¿®æ­£

- userID ã«ã¯ä½œæˆã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†ã®ã§userIDã®æ•°å­—ã‚’ ${USERID}ã«å¤‰æ›´ã™ã‚‹
- ignore_changes ã‚’ä½œæˆã—ãŸç’°å¢ƒå¤‰æ•°ã‚’æ¶ˆã•ãªã„æ§˜ã«ã™ã‚‹

### importã®å®Ÿæ–½

codebuild.tfãŒå‡ºæ¥ãŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§importã‚’å®Ÿè¡Œ

```
terraform apply
â€»USERIDã‚’æ‰‹å…¥åŠ›
```

### GUIä¸Šã¨terraformã«å·®åˆ†ãŒãªã„äº‹ã‚’ç¢ºèªã™ã‚‹

terraform Planã§å·®åˆ†ãŒãªã‘ã‚Œã°ç„¡äº‹terraformç®¡ç†ä¸‹ã«ãªã£ã¦ã„ã‚‹ã€‚

```
terraform plan
â€»USERIDã‚’æ‰‹å…¥åŠ›
```

### CI/CDã§ã‚‚ã†ã¾ãã„ãã“ã¨ã‚’ç¢ºèª

PRã‚’ä½œã£ã¦ãƒãƒ¼ã‚¸ã—ã¦ç¢ºèª

## æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰

https://github.com/zukizukizuki/aws-terraform/tree/0f4d80efcc70919ea1bd80f7ed2962e53c9f1c7c

## è¿½è¨˜ â€»2023/8/1

Terraform v1.5.4 æ™‚ç‚¹ã§ã¯Â importÂ ãƒ–ãƒ­ãƒƒã‚¯ã®Â idÂ ã«ã¯æ–‡å­—åˆ—ã—ã‹æŒ‡å®šã§ãã¾ã›ã‚“ã€‚
Variableã‚’ä½¿ç”¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚
â€»Local Value , ãƒªã‚½ãƒ¼ã‚¹ã® attribute ã§ã‚‚åŒæ§˜

```
Error: Unsuitable value type

  on imports.tf line 26, in import:
  26:   id = "arn:aws:iam::${var.USERID}:policy/service-role/CodeBuildBasePolicy-terraform-apply-ap-northeast-1"

Unsuitable value: value must be known

Error: Variables not allowed

  on imports.tf line 26, in import:
  26:   id = "arn:aws:iam::${var.USERID}:policy/service-role/CodeBuildBasePolicy-terraform-apply-ap-northeast-1"

Variables may not be used here.
```
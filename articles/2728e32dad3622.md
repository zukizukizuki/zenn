---
title: "ã€AWSã€‘CodeBuildã§terraformã«CICDã‚’çµ„ã‚€"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform" , "aws" , "codebuild" , "ci" , "cd"]
published: true
---

## æ¦‚è¦

CICDã‚’çµ„ã‚€ã¨ã¿ã‚“ãª(CICDç®¡ç†è€…ã‚’é™¤ã)å¹¸ã›ã«ãªã‚Œã‚‹ã®ã§AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦å…ˆæ—¥ä½œã£ãŸaws-terraformã«CICDã‚’çµ„ã‚€
(æœ¬å½“ã¯gitub actionsã§çµ„ã¿ãŸã‹ã£ãŸã‘ã©[ã“ã®issues](https://github.com/aws-actions/configure-aws-credentials/issues/680)ãŒè§£æ±ºã™ã‚‹ã¾ã§å¾…ã¡)

## CodeBuildã¨ã¯ï¼Ÿ

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(buildspec.yml)ã§æŒ‡å®šã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã§è‰²ã€…ã—ã¦ãã‚Œã‚‹
ä»Šå›ã¯terraform planã¨terraform applyã‚’å®Ÿè¡Œã™ã‚‹shell scriptã‚’ç”¨æ„ã—ã¦ãã‚Œã‚’è¹´ã‚‹ãŸã‚ã«ä½¿ã†

ä½™è«‡ã§ã™ãŒ
**CodePipeline**ã¨ã„ã†githubã®æ›´æ–°ã¨é€£å‹•ã—ã¦CodeBuildã‚„CodeDeployã‚’å‘¼ã³å‡ºã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨
**CodeDeploy**ã¨ã„ã†EC2ã€ECSã€Fargateç­‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨
**CodeCommi**tã¨ã„ã†AWSç‰ˆgithubã¿ãŸã„ãªã‚µãƒ¼ãƒ“ã‚¹
ãŒã‚ã‚‹ã‘ã©CodeBuildå˜ä½“ã§githubã¨é€£æºå‡ºæ¥ã‚‹ã®ã¨ä»Šå›ã¯EC2ç­‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã‚ãªã„ã®ã¨æ™®æ®µgithubã°ã‹ã‚Šä½¿ã£ã¦ã„ã‚‹ã®ã§ã§ä»Šå›ã“ã‚Œã‚‰ã¯ä½¿ã‚ãªã„

## ã‚„ã‚‹äº‹

ä»¥å‰ä½œã£ãŸaws-terraformã«ä»¥ä¸‹ã®å›³ã®ã‚ˆã†ãªæ§‹æˆã§
ãƒ»githubã®mainãƒ–ãƒ©ãƒ³ãƒã¸ã®PRä½œæˆã€å¤‰æ›´ãŒè¡Œã‚ã‚ŒãŸã‚‰è‡ªå‹•terraform Plan
ãƒ»githubã®mainãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã‚‰è‡ªå‹•terraform apply
ã‚’å®Ÿæ–½å‡ºæ¥ã‚‹æ§˜ã«ã—ã¾ã™ã€‚

â€»aws-terraformã‚’ä½œæˆã—ãŸè¨˜äº‹ã¯[ã“ã¡ã‚‰](https://zukkie.link/%e3%80%90aws%e3%80%91terraform%e3%81%a7%e3%82%a4%e3%83%b3%e3%83%95%e3%83%a9%e3%83%aa%e3%82%bd%e3%83%bc%e3%82%b9%e3%82%92%e7%ae%a1%e7%90%86/)

![](https://storage.googleapis.com/zenn-user-upload/20760b26c37e-20230808.png)

## githubã«ã‚³ãƒ¼ãƒ‰ã‚’æº–å‚™

### codebuild/buildspec-dryrun.yml ã®ä½œæˆ

codebuildãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€buildspec-dryrun.ymlã‚’ä½œæˆã™ã‚‹ã€‚

```
version: 0.2

phases:
  install:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/install.sh
      - ${CODEBUILD_SRC_DIR}/scripts/install.sh

  build:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/dryrun.sh
      - ${CODEBUILD_SRC_DIR}/scripts/dryrun.sh
```

å‚è€ƒ ï¼š https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/build-spec-ref.html
ã€€ã€€  ã€€https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/build-env-ref-env-vars.html
ã€€ã€€ã€€  https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/sample-github-pull-request.html

### scripts/install.shã®ä½œæˆ

scriptsãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€install.shã‚’ä½œæˆã™ã‚‹ã€‚

```
#!/bin/sh

set -ex

TERRAFORM_VERSION="1.5.4"

wget -q "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
unzip -d /usr/local/bin "terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
```

### scripts/dryrun.shã®ä½œæˆ

```
#!/bin/sh
set -ex
terraform init -input=false -no-color -backend-config="key=terraform.tfstate" -backend-config="bucket=zukkie-terraform-state"
terraform plan -no-color
```

### codebuild/buildspec-apply.yml ã®ä½œæˆ

```
version: 0.2

phases:
  install:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/install.sh
      - ${CODEBUILD_SRC_DIR}/scripts/install.sh

  build:
    commands:
      - chmod +x ${CODEBUILD_SRC_DIR}/scripts/apply.sh
      - ${CODEBUILD_SRC_DIR}/scripts/apply.sh
```

### scripts/apply.shã®ä½œæˆ

```
#!/bin/sh
set -ex
terraform init -input=false -no-color -backend-config="key=terraform.tfstate" -backend-config="bucket=zukkie-terraform-state"
terraform apply -auto-approve -no-color
```

### å…¨ã¦ä½œæˆæ¸ˆã¿ã®github

https://github.com/zukizukizuki/aws-terraform/tree/ed769063d38704102655cc80c2578391255a9889

## dryrunç”¨ã®CodeBuildã®è¨­å®š

### CodeBuildã®ä½œæˆ

1. CodeBuildã«ç§»å‹•ã—ã€"ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹"ã‚’æŠ¼ä¸‹

2. ä»¥ä¸‹ã®è¨­å®šã§Planç”¨ã®CodeBuildã‚’ä½œæˆã™ã‚‹ã€‚

```
ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå â†’ ä»»æ„
ãƒ»ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ â†’ github(SSOã§githubã«æ¥ç¶š)
ãƒ»ãƒªãƒã‚¸ãƒˆãƒª â†’ GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒã‚¸ãƒˆãƒª
ãƒ»GitHub ãƒªãƒã‚¸ãƒˆãƒª â†’ https://github.com/zukizukizuki/aws-terraform.git
ãƒ»"ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒã“ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãŸã³ã«å†æ§‹ç¯‰ã™ã‚‹"ã«ãƒã‚§ãƒƒã‚¯
ãƒ»"ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã‚°ãƒ«ãƒ¼ãƒ— 1"ã«"PULL_REQUEST_CREATED" ã¨"PULL_REQUEST_UPDATED"ã‚’é¸æŠ
ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  â†’ Amazon linux 2
ãƒ»ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  â†’ Standard
ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ â†’ ä»»æ„
ãƒ»Buildspecå â†’ codebuild/buildspec-dryrun.yml
ã€€â€»ä»–ã¯å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
```

### ãƒ­ãƒ¼ãƒ«ã«S3èª­ã¿å–ã‚Šæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹

terraformã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†æ™‚ã«S3ã«ã‚ã‚‹ stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹ã®ã§èª­å–æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

1. IAMã¸ç§»å‹•ã—ã€IAMãƒªã‚½ãƒ¼ã‚¹ ã® ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠ
2. CodeBuildã«ç´ã¥ã„ã¦ã‚‹ãƒ­ãƒ¼ãƒ«åã‚’æŠ¼ä¸‹
3. "è¨±å¯ã‚’è¿½åŠ " â†’ "ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ"ã‚’æŠ¼ä¸‹
4. AmazonS3ReadOnlyAccess ã‚’é¸æŠã—ã€"è¨±å¯ã‚’è¿½åŠ "ã‚’æŠ¼ä¸‹

### CIã®å‹•ä½œç¢ºèª

ãªã‚“ã§ã‚‚ã„ã„ã®ã§PRã‚’ä½œã£ã¦CIãŒå‹•ãäº‹ã‚’ç¢ºèªã™ã‚‹

## applyç”¨ã®CodeBuildã®è¨­å®š

1. CodeBuildã«ç§»å‹•ã—ã€"ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹"ã‚’æŠ¼ä¸‹
2. ä»¥ä¸‹ã®è¨­å®šã§Planç”¨ã®CodeBuildã‚’ä½œæˆã™ã‚‹ã€‚

```
ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå â†’ ä»»æ„
ãƒ»ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ â†’ github(SSOã§githubã«æ¥ç¶š)
ãƒ»ãƒªãƒã‚¸ãƒˆãƒª â†’ GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒã‚¸ãƒˆãƒª
ãƒ»GitHub ãƒªãƒã‚¸ãƒˆãƒª â†’ https://github.com/zukizukizuki/aws-terraform.git
ãƒ»"ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒã“ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãŸã³ã«å†æ§‹ç¯‰ã™ã‚‹"ã«ãƒã‚§ãƒƒã‚¯
ãƒ»"ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã‚°ãƒ«ãƒ¼ãƒ— 1"ã«"PULL_REQUEST_MERGED" ã‚’é¸æŠ
ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  â†’ Amazon linux 2
ãƒ»ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  â†’ Standard
ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ â†’ ä»»æ„
ãƒ»Buildspecå â†’ codebuild/buildspec-apply.yml
ã€€â€»ä»–ã¯å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
```

### ãƒ­ãƒ¼ãƒ«ã«PowerUseræ¨©é™ã‚’ä»˜ä¸ã™ã‚‹

dryrunç”¨ã®CodeBuildã¨åŒæ§˜ã« S3ã®èª­å–æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
è‰²ã‚“ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹äº‹ã«ãªã‚‹ã®ã§ä»Šå›ã¯PowerUseræ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã€‚

â€»æœ¬æ¥ã¯ã‚‚ã£ã¨æ¨©é™ã‚’çµã‚‹ã¹ãã§ã™ã€‚

### CDã®å‹•ä½œç¢ºèª

ãªã‚“ã§ã‚‚ã„ã„ã®ã§PRã‚’ãƒãƒ¼ã‚¸ã—ã¦CDãŒå‹•ãäº‹ã‚’ç¢ºèªã™ã‚‹